<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Anti-Trivia — Host</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Anton&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    @font-face {
      font-family: 'Hello Imperfect';
      src: url('/fonts/HelloImperfect.otf') format('opentype');
      font-weight: normal;
    }
    @font-face {
      font-family: 'Brother 1816 Printed';
      src: url('/fonts/Brother1816Printed-Bold.ttf') format('truetype');
      font-weight: bold;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    input, button, select { border-radius: 100px !important; }
    textarea { border-radius: 16px !important; }

    body {
      background-color: #c8b89a;
      background-image: url('/images/paper.webp');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      color: #1a1a1a;
      font-family: 'Poppins', 'Segoe UI', sans-serif;
      min-height: 100vh;
      padding: 20px;
    }

    /* ── Header ── */
    header {
      text-align: center;
      margin-bottom: 24px;
      padding: 28px 20px 24px;
      border-bottom: 3px solid #000;
    }
    .reset-btn {
      position: absolute;
      top: 16px;
      right: 20px;
      padding: 7px 14px;
      background: transparent;
      border: 2px solid #000;
      color: rgba(0,0,0,0.55);
      font-family: 'Brother 1816 Printed', 'Anton', sans-serif;
      font-size: 0.68rem;
      font-weight: bold;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      opacity: 0.7;
      transition: opacity 0.15s, border-color 0.15s;
    }
    .reset-btn:hover { opacity: 1; border-color: rgba(0,0,0,0.5); }

    header h1 {
      font-family: 'Hello Imperfect', 'Anton', sans-serif;
      font-size: 4.5rem;
      color: #1a1a1a;
      text-shadow: none;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      line-height: 1;
    }
    .header-sub {
      display: inline-block;
      font-family: 'Brother 1816 Printed', 'Anton', sans-serif;
      font-size: 0.72rem;
      color: #1a1a1a;
      background: rgba(0,0,0,0.1);
      padding: 3px 16px;
      letter-spacing: 0.3em;
      text-transform: uppercase;
      margin-top: 8px;
      border-radius: 100px;
    }

    /* ── Layout ── */
    .grid {
      display: grid;
      grid-template-columns: 340px 1fr;
      gap: 20px;
      align-items: start;
    }

    /* ── Panels ── */
    .panel {
      background: rgba(0,0,0,0.07);
      border: 1px solid #000;
      border-radius: 16px;
      padding: 18px 20px;
      margin-bottom: 14px;
    }
    .panel-title {
      font-family: 'Brother 1816 Printed', 'Anton', sans-serif;
      font-size: 0.7rem;
      color: rgba(0,0,0,0.45);
      text-transform: uppercase;
      letter-spacing: 0.28em;
      margin-bottom: 14px;
      padding-bottom: 8px;
      border-bottom: 1px solid #000;
    }

    /* ── Question type toggle ── */
    .type-toggle { display: flex; gap: 8px; margin-bottom: 12px; }
    .type-btn {
      flex: 1;
      padding: 8px;
      border: 2px solid #000;
      background: rgba(0,0,0,0.06);
      color: rgba(0,0,0,0.4);
      font-family: 'Brother 1816 Printed', 'Anton', sans-serif;
      font-size: 0.78rem;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      transition: all 0.12s;
    }
    .type-btn.active {
      background: rgba(0,0,0,0.7);
      color: #fff;
      border-color: #000;
    }

    textarea {
      width: 100%;
      background: rgba(0,0,0,0.06);
      border: 2px solid #000;
      color: #1a1a1a;
      font-family: 'Poppins', sans-serif;
      font-size: 0.95rem;
      padding: 10px 12px;
      resize: vertical;
      min-height: 72px;
      margin-bottom: 10px;
    }
    textarea:focus { outline: none; border-color: #000; }
    textarea::placeholder { color: rgba(0,0,0,0.35); }

    /* ── Buttons ── */
    .btn-row { display: flex; gap: 8px; }
    button {
      padding: 9px 16px;
      border: none;
      font-family: 'Brother 1816 Printed', 'Anton', sans-serif;
      font-size: 0.8rem;
      font-weight: bold;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      transition: transform 0.08s;
    }
    button:active { transform: translate(1px, 1px); }

    .btn-primary {
      background: rgba(0,0,0,0.75);
      color: #fff;
      flex: 1;
    }

    .btn-ghost {
      background: transparent;
      border: 2px solid #000;
      color: rgba(0,0,0,0.5);
    }
    .btn-ghost:hover { color: #1a1a1a; }

    .btn-danger {
      background: rgba(0,0,0,0.06);
      color: rgba(0,0,0,0.55);
      border: 2px solid #000;
    }
    .btn-danger:hover { background: rgba(0,0,0,0.12); }

    .btn-small { padding: 5px 10px; font-size: 0.7rem; }
    .btn-icon { padding: 5px 10px; font-size: 0.9rem; min-width: 34px; text-align: center; }

    /* ── Active question ── */
    .current-q {
      background: rgba(0,0,0,0.06);
      border: 2px solid #000;
      border-radius: 16px;
      padding: 12px 14px;
      font-size: 0.92rem;
      font-weight: 600;
      color: #1a1a1a;
      line-height: 1.45;
      display: none;
    }
    .current-q.show { display: block; }
    .q-label {
      font-family: 'Brother 1816 Printed', 'Anton', sans-serif;
      font-size: 0.65rem;
      color: rgba(0,0,0,0.45);
      letter-spacing: 0.22em;
      text-transform: uppercase;
      margin-bottom: 5px;
    }
    .no-q-msg {
      font-family: 'Brother 1816 Printed', 'Anton', sans-serif;
      color: rgba(0,0,0,0.3);
      font-size: 0.85rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
    }

    /* ── History ── */
    .history-list {
      max-height: 200px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .history-item {
      padding: 8px 12px;
      background: rgba(0,0,0,0.06);
      border-radius: 0 8px 8px 0;
      border-left: 3px solid #000;
      font-size: 0.82rem;
      color: rgba(0,0,0,0.55);
      line-height: 1.4;
    }
    .history-item .h-num {
      font-family: 'Brother 1816 Printed', 'Anton', sans-serif;
      font-size: 0.65rem;
      color: rgba(0,0,0,0.4);
      display: block;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      margin-bottom: 2px;
    }
    .no-history {
      font-family: 'Brother 1816 Printed', 'Anton', sans-serif;
      color: rgba(0,0,0,0.3);
      font-size: 0.8rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
    }

    /* ── Teams grid ── */
    .teams-header { display: flex; align-items: center; margin-bottom: 14px; }
    .team-count {
      font-family: 'Brother 1816 Printed', 'Anton', sans-serif;
      font-size: 0.72rem;
      color: rgba(0,0,0,0.5);
      text-transform: uppercase;
      letter-spacing: 0.2em;
    }

    .teams-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 14px;
    }

    .team-card {
      background: rgba(0,0,0,0.07);
      border: 1px solid #000;
      border-radius: 16px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .team-card-top {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 8px;
    }
    .team-name-display {
      font-family: 'Anton', sans-serif;
      font-size: 1.2rem;
      color: #1a1a1a;
      letter-spacing: 0.04em;
      line-height: 1.2;
      word-break: break-word;
    }

    .score-controls { display: flex; align-items: center; gap: 4px; flex-shrink: 0; }
    .score-display {
      font-family: 'Anton', sans-serif;
      font-size: 1.8rem;
      color: #1a1a1a;
      min-width: 46px;
      text-align: center;
      line-height: 1;
    }

    .set-score-row { display: flex; gap: 6px; }
    .set-score-input {
      flex: 1;
      background: rgba(0,0,0,0.06);
      border: 2px solid #000;
      color: #1a1a1a;
      font-family: 'Poppins', sans-serif;
      font-size: 0.85rem;
      padding: 5px 8px;
    }
    .set-score-input:focus { outline: none; border-color: #000; }
    .set-score-input::placeholder { color: rgba(0,0,0,0.35); }

    .answer-label {
      font-family: 'Brother 1816 Printed', 'Anton', sans-serif;
      font-size: 0.65rem;
      color: rgba(0,0,0,0.45);
      letter-spacing: 0.15em;
      text-transform: uppercase;
      margin-bottom: 4px;
    }
    .answer-preview {
      background: rgba(0,0,0,0.05);
      border: 1px solid #000;
      border-radius: 12px;
      padding: 8px 10px;
      font-size: 0.85rem;
      color: rgba(0,0,0,0.35);
      font-style: italic;
      word-break: break-word;
      line-height: 1.4;
    }
    .answer-preview.has-answer { color: #1a1a1a; font-style: normal; }
    .answer-preview img {
      max-width: 100%;
      max-height: 140px;
      border-radius: 8px;
      display: block;
    }

    .card-actions { display: flex; gap: 6px; flex-wrap: wrap; align-items: center; }

    .btn-highlight {
      background: rgba(0,0,0,0.06);
      color: rgba(0,0,0,0.55);
      border: 2px solid #000;
    }
    .btn-highlight:hover { background: rgba(0,0,0,0.12); }
    .btn-highlight.active { background: rgba(0,0,0,0.7); color: #fff; border-color: #000; }

    .empty-teams {
      color: rgba(0,0,0,0.3);
      font-family: 'Brother 1816 Printed', 'Anton', sans-serif;
      font-size: 1rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      padding: 30px;
      text-align: center;
      grid-column: 1 / -1;
    }
  </style>
</head>
<body>
  <header style="position:relative">
    <h1>Slow Body</h1>
    <div class="header-sub">Anti-Trivia · Host Dashboard</div>
    <button class="reset-btn" onclick="resetGame()">↺ New Game</button>
  </header>

  <div class="grid">
    <!-- Left sidebar -->
    <div>
      <div class="panel">
        <div class="panel-title">Push Question</div>
        <div class="type-toggle">
          <button class="type-btn active" id="typeBtnText" onclick="setQType('text')">Text</button>
          <button class="type-btn" id="typeBtnDrawing" onclick="setQType('drawing')">Drawing</button>
        </div>
        <textarea id="qInput" placeholder="Enter question…"></textarea>
        <div class="btn-row">
          <button class="btn-primary" onclick="pushQ()">Push Question</button>
          <button class="btn-ghost" onclick="clearQ()">Clear</button>
        </div>
      </div>

      <div class="panel">
        <div class="panel-title">Active Question</div>
        <div class="current-q" id="currentQ">
          <div class="q-label" id="qNumLabel"></div>
          <div id="qTextDisplay"></div>
        </div>
        <div class="no-q-msg" id="noQMsg">No Active Question</div>
      </div>

      <div class="panel">
        <div class="panel-title">Question History</div>
        <div class="history-list" id="historyList">
          <div class="no-history">No Questions Yet</div>
        </div>
      </div>
    </div>

    <!-- Teams -->
    <div>
      <div class="teams-header">
        <div class="team-count" id="teamCount">0 Teams</div>
      </div>
      <div class="teams-grid" id="teamsGrid">
        <div class="empty-teams">Waiting for teams to join…</div>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    let state = {
      teams: [],
      question: null,
      questionHistory: [],
      highlightedTeamName: null,
    };
    let questionType = 'text';

    socket.on('connect', () => socket.emit('host:join'));
    socket.on('host:state', s => { state = s; render(); });

    function resetGame() {
      if (!confirm('Start a new game? This will remove all teams and reset everything.')) return;
      socket.emit('host:reset-game');
    }

    function setQType(type) {
      questionType = type;
      document.getElementById('typeBtnText').classList.toggle('active', type === 'text');
      document.getElementById('typeBtnDrawing').classList.toggle('active', type === 'drawing');
    }

    function pushQ() {
      const text = document.getElementById('qInput').value.trim();
      if (!text) return;
      socket.emit('host:push-question', { text, type: questionType });
      document.getElementById('qInput').value = '';
    }

    document.getElementById('qInput').addEventListener('keydown', e => {
      if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) pushQ();
    });

    function clearQ() { socket.emit('host:clear-question'); }
    function award(teamId, delta) { socket.emit('host:award-points', { teamId, delta }); }
    function setScore(teamId, inputEl) {
      const score = parseInt(inputEl.value);
      if (isNaN(score)) return;
      socket.emit('host:set-score', { teamId, score });
      inputEl.value = '';
    }
    function removeTeam(teamId) {
      if (!confirm('Remove this team?')) return;
      socket.emit('host:remove-team', { teamId });
    }
    function toggleHighlight(teamName) { socket.emit('host:highlight-team', { teamName }); }

    function esc(s) {
      return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    function render() {
      const q = state.question;
      const currentQ = document.getElementById('currentQ');
      const noQMsg = document.getElementById('noQMsg');
      if (q) {
        document.getElementById('qNumLabel').textContent = `Question ${q.number} · ${(q.type || 'text').toUpperCase()}`;
        document.getElementById('qTextDisplay').textContent = q.text;
        currentQ.classList.add('show');
        noQMsg.style.display = 'none';
      } else {
        currentQ.classList.remove('show');
        noQMsg.style.display = '';
      }

      const histEl = document.getElementById('historyList');
      if (state.questionHistory && state.questionHistory.length) {
        histEl.innerHTML = [...state.questionHistory].reverse().map(hq =>
          `<div class="history-item">
            <span class="h-num">Q${hq.number} · ${(hq.type || 'text').toUpperCase()}</span>
            ${esc(hq.text)}
          </div>`
        ).join('');
      } else {
        histEl.innerHTML = '<div class="no-history">No Questions Yet</div>';
      }

      const teams = state.teams || [];
      document.getElementById('teamCount').textContent =
        `${teams.length} Team${teams.length !== 1 ? 's' : ''}`;

      const grid = document.getElementById('teamsGrid');
      if (!teams.length) {
        grid.innerHTML = '<div class="empty-teams">Waiting for teams to join…</div>';
        return;
      }

      const highlightedName = state.highlightedTeamName;

      grid.innerHTML = teams.map(t => {
        const hasAnswer = t.answer !== null && t.answer !== undefined && t.answer !== '';
        const isImg = hasAnswer && typeof t.answer === 'string' && t.answer.startsWith('data:image');
        const isHighlighted = highlightedName === t.name;

        let answerContent;
        if (!hasAnswer) {
          answerContent = `<div class="answer-preview">no answer yet…</div>`;
        } else if (isImg) {
          answerContent = `
            <div class="answer-label">Drawing</div>
            <div class="answer-preview has-answer"><img src="${t.answer}" alt="drawing" /></div>`;
        } else {
          answerContent = `
            <div class="answer-label">Answer</div>
            <div class="answer-preview has-answer">${esc(t.answer)}</div>`;
        }

        const safeId = esc(t.id);
        const safeName = esc(t.name);

        const highlightBtn = hasAnswer
          ? `<button class="btn-small btn-highlight ${isHighlighted ? 'active' : ''}" data-name="${safeName}" onclick="toggleHighlight(this.dataset.name)">${isHighlighted ? 'Unhighlight' : 'Highlight'}</button>`
          : '';

        return `
          <div class="team-card">
            <div class="team-card-top">
              <div class="team-name-display">${esc(t.name)}</div>
              <div class="score-controls">
                <button class="btn-icon btn-ghost" data-id="${safeId}" onclick="award(this.dataset.id, -1)">−</button>
                <div class="score-display">${t.score}</div>
                <button class="btn-icon btn-ghost" data-id="${safeId}" onclick="award(this.dataset.id, 1)">+</button>
              </div>
            </div>
            <div class="set-score-row">
              <input class="set-score-input" type="number" placeholder="Set score…" data-id="${safeId}"
                onkeydown="if(event.key==='Enter') setScore(this.dataset.id, this)" />
              <button class="btn-small btn-ghost" data-id="${safeId}" onclick="setScore(this.dataset.id, this.previousElementSibling)">Set</button>
            </div>
            ${answerContent}
            <div class="card-actions">
              ${highlightBtn}
              <button class="btn-small btn-danger" style="margin-left:auto" data-id="${safeId}" onclick="removeTeam(this.dataset.id)">Remove</button>
            </div>
          </div>`;
      }).join('');
    }
  </script>
</body>
</html>
